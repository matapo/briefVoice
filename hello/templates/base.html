<!DOCTYPE html>
<html>
<head>
    <title>Brief Voice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    {% load staticfiles %}
    <link rel='stylesheet' href="{% static 'styles.css' %}">
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
</head>

<body>

<div id="root-container" class="mainDiv">
    <div id="root"> </div>
    <div class="spotify-frame">
        <iframe
                src="https://open.spotify.com/embed/user/mataspo/playlist/4iBO7KQXgzfV3z2OJ1YFUt"
                width="100%"
                height="100%"
                frameborder="0"
                allowtransparency="true"
                allow="encrypted-media">
        </iframe>
    </div>
</div>

<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
<link
        rel='stylesheet'
        href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css'
        type='text/css'
/>

<div class="mapDiv" id='map'></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWF0YXMtcG9jZXZpY2l1cyIsImEiOiJjanQxbjRkdnEwY2Z3M3pwMzhjaWt0aHdkIn0.vPMyhueqXv5NMGMud0FjLA';
    var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    zoom: 15,
    center: [8.5417, 47.3769]
    });

    var longitudeMatui = null;
    setInterval(
        () => axios.get(`http://130.82.239.210/signal/NP_LongDegree`)
            .then(response => {
                longitudeMatui = response.data.signal.measurement.value;
                console.log(`${longitudeMatui}`)
            }), 1000
    );

    var latitudeMatui = null;
    setInterval(
        () => axios.get(`http://130.82.239.210/signal/NP_LatDegree`)
            .then(response => {
                latitudeMatui = response.data.signal.measurement.value;
                console.log(`${latitudeMatui}`)
            }), 1000
    );

    map.addControl(new MapboxDirections({
      accessToken: mapboxgl.accessToken
    }), 'top-right');

    // Add geolocate control to the map.
    let geoTracker = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      showUserLocation: true,
      trackUserLocation: true
    });


    map.addControl(geoTracker,'top-left');

    map.on('load', function()
    {
    	geoTracker.trigger();
    });

    geoTracker.on('geoTracker', function()
      {

      //Get the updated user location, this returns a javascript object.
      var userlocation = geolocate._lastKnownPosition;

      //Your work here - Get coordinates like so
      var lat = userlocation.coords.latitude;
      var lng = userlocation.coords.longitude;

    });

</script>


<script type="text/babel">
    class SignalInformation extends React.Component {
        constructor(props) {
            super(props);

            this.state = {
                signalData: null,
                speaking: false,
            }
        }

        componentDidMount() {
            this.timer = setInterval(
                () => axios.get(`http://130.82.239.210/signal/${this.props.name}`)
                    .then(response => {
                        if (this.props.name === 'AB_Gurtschloss_FA') {
                            const valueMap = {
                                0: 'Not Built-in',
                                1: 'Initialization',
                                2: 'Not Fastened',
                                3: 'Fastened',
                            };
                            this.setState({signalData: valueMap[response.data.signal.measurement.value],
                            });
                            if (valueMap[response.data.signal.measurement.value] !== 'Fastened'
                                && !this.state.speaking) {
                                var msg = new SpeechSynthesisUtterance('Please put the seatbelt on.');
                                window.speechSynthesis.speak(msg);
                            }
                        } else if(this.props.name === 'KBI_Tankfuellstand_Prozent'
                            || this.props.name === 'FS_Luftfeuchte_rel') {
                            this.setState({signalData: `${response.data.signal.measurement.value}%`,
                            })
                        } else if (this.props.name.includes("Temp")) {
                            this.setState({signalData: `${response.data.signal.measurement.value} C`,
                            })
                        } else if (this.props.name === 'ESP_v_Signal') {
                            this.setState({signalData: `${response.data.signal.measurement.value.toFixed(3)} m/s`,
                            })
                        } else if (this.props.name === 'ESP_Laengsbeschl') {
                            this.setState({signalData: `${response.data.signal.measurement.value.toFixed(3)} m/s^2`,
                            })
                        } else if (this.props.name === 'ESP_Bremsdruck') {
                            this.setState({signalData: `${response.data.signal.measurement.value.toFixed(3)} Bar`,
                            })
                        } else {
                            this.setState({
                                signalData: `${response.data.signal.measurement.value}`,
                            })
                        }
                    }), 1000
            )
        }

        render() {
            const {
                name,
                translation,
            } = this.props;
            const signalData = this.state.signalData;
            const textElement = <div className="textElement">
                <p className={`${name}-${signalData ? signalData : null}`}>
                    {`${translation}: ${signalData}`}
                </p>
            </div>;
            return textElement
        };
    }

    class SignalInformationContainer extends React.Component {
        constructor(props) {
            super(props);

            this.state = {
                signalNames: [
                    'ESP_v_Signal',
                    'MO_Gangposition',
                    'ESP_Laengsbeschl',
                    'AB_Gurtschloss_FA',
                    'MO_Drehzahl_01',
                    'KBI_Tankfuellstand_Prozent',
                    'ESP_Bremsdruck',
                    'KBI_Aussen_Temp_gef',
                    'FS_Temp_Sensor',
                    'FS_Luftfeuchte_rel',
                ],
                signalTranslations: {
                    'ESP_Bremsdruck': 'Brake Pressure',
                    'MO_Drehzahl_01': 'RPM',
                    'KBI_Tankfuellstand_Prozent': 'Gas Level',
                    'ESP_Laengsbeschl': 'Acceleration',
                    'AB_Gurtschloss_FA': 'The Seat Belt',
                    'KBI_Aussen_Temp_gef': 'Outside Temperature',
                    'FS_Temp_Sensor': 'In-car Temperature',
                    'FS_Luftfeuchte_rel': 'In-car Humidity',
                    'ESP_v_Signal': 'Current Speed',
                    'MO_Gangposition': 'Current Gear',
                },
                isSpeaking: false,
            }

        }

        changeSpeakingState() {
            this.setState({
                isSpeaking: !this.state.isSpeaking,
            })
        }

        render() {
            return <div>
                {this.state.signalNames ? this.state.signalNames.map(name =>
                    <SignalInformation
                        key={name}
                        name={name}
                        translation={this.state.signalTranslations[name]}
                        changeSpeakingState={() => this.changeSpeakingState()}
                    />
                ) : null}
            </div>;
        }
    }
    ReactDOM.render(
        <SignalInformationContainer />,
        document.getElementById('root')
    );
</script>

</body>
</html>
